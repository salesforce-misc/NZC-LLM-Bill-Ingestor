<template>
    <div class="ai-glass-card">
        <!-- Header updated with a new SVG icon -->
        <div class="ai-header">
            <div class="ai-avatar">
                <!-- This new SVG is simpler and more reliable for deployment -->
                <svg viewBox="0 0 64 64" class="ai-hero-icon">
                    <g>
                        <!-- Tree Trunk -->
                        <path d="M 30 58 L 30 42 C 30 40 32 40 32 42 L 32 58 Z" fill="#795548"/>
                        <!-- Tree Leaves -->
                        <circle cx="31" cy="28" r="14" fill="#4CAF50"/>
                        <circle cx="22" cy="34" r="10" fill="#66BB6A"/>
                        <circle cx="40" cy="34" r="10" fill="#81C784"/>
                    </g>
                </svg>
            </div>
            <div>
                <div class="ai-title">Bill Importer<span class="ai-blink">âœ¨</span></div>
                <div class="ai-caption">Let AI import your Bills instantly</div>
            </div>
        </div>

        <!-- File upload and selection section -->
   
        <lightning-tabset active-tab-value="upload" variant="scoped">
            <lightning-tab label="Upload New File" value="upload">
                <div class="ai-upload-wrapper slds-p-around_medium">
                    <lightning-file-upload
                        label="Upload Image or PDF"
                        name="uploadFile"
                        multiple="false"
                        accept=".jpg,.jpeg,.png,.pdf"
                        record-id={recordId}
                        onuploadfinished={fileUploadHandler}>
                    </lightning-file-upload>
                </div>
            </lightning-tab>
            <lightning-tab label="Select Existing File" value="existing">
                <div class="slds-p-around_medium">
                    <template if:true={hasFiles}>
                        <lightning-combobox
                            name="existingFiles"
                            label="Choose a file from this record"
                            value={uploadedFileId}
                            placeholder="Select a file..."
                            options={fileOptions}
                            onchange={handleFileSelectionChange}>
                        </lightning-combobox>
                    </template>
                    <template if:false={hasFiles}>
                        <div class="slds-text-align_center slds-p-vertical_medium slds-text-color_weak">
                            No existing files found on this record.
                        </div>
                    </template>
                </div>
            </lightning-tab>
        </lightning-tabset>

        <!-- Selected file display remains the same -->
        <template if:true={uploadedFileName}>
            <div class="ai-uploaded-file slds-m-left_medium slds-m-right_medium">
                <lightning-icon icon-name="doctype:image" size="x-small"></lightning-icon>
                <span class="ai-uploaded-file-name">{uploadedFileName}</span>
            </div>
        </template>

        <!-- Analyze button remains the same -->
        <lightning-button
            variant="brand"
            label="Analyze Selected File"
            icon-name="utility:einstein"
            class="ai-analyze-btn slds-m-top_medium"
            disabled={disableAnalyzeButton}
            onclick={handleAnalyzeFiles}>
        </lightning-button>

        <!-- Loading and Error sections remain the same -->
        <template if:true={isLoading}>
            <div class="ai-loading">
                <div class="ai-loader"></div>
                <span class="ai-analyzing">Analyzing with AIâ€¦</span>
            </div>
        </template>
        <template if:true={errorMessage}>
            <div class="ai-error">
                <lightning-icon icon-name="utility:error" size="x-small"></lightning-icon>
                <span>{errorMessage}</span>
            </div>
        </template>

        <!-- NEW: Updated AI Analysis Result Section -->
        <template if:true={aiResult}>
            <div class="ai-result">
                <!-- Display single object result -->
                <template if:true={isSingleResult}>
                    <div class="ai-result-single">
                        <h3 class="ai-result-title">
                            <lightning-icon icon-name="utility:bot" size="small"></lightning-icon>
                            Analysis Result
                        </h3>
                        <table class="slds-table slds-table_cell-buffer slds-table_bordered ai-result-table">
                            <tbody>
                                <template for:each={resultData} for:item="item">
                                    <tr key={item.id}>
                                        <th scope="row" class="ai-result-key">{item.label}</th>
                                        <td class="ai-result-value">{item.value}</td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </template>

                <!-- Display array of objects result using lightning-datatable -->
                <template if:true={isArrayResult}>
                    <div class="ai-result-array">
                        <h3 class="ai-result-title">
                            <lightning-icon icon-name="utility:bot" size="small"></lightning-icon>
                            Analysis Results ({arrayItemCount} items found)
                        </h3>
                        <div class="ai-result-datatable">
                            <p class="ai-table-hint">ðŸ’¡ Click the blue action button (â‹®) and select "View Details" to see full record information</p>
                            <lightning-datatable
                                data={resultData}
                                columns={tableColumns}
                                key-field="Id"
                                hide-checkbox-column="true"
                                show-row-number-column="false"
                                resize-column-disabled="false"
                                sorted-direction="asc"
                                sorted-by="rowIndex"
                                class="ai-datatable"
                                onrowaction={handleRowAction}>
                            </lightning-datatable>
                        </div>

                        <!-- Dedicated Detail Component -->
                        <c-energy-record-detail 
                            record-data={selectedRowData}
                            show-component={showDetailView}
                            onclosedetail={handleCloseDetails}>
                        </c-energy-record-detail>
                    </div>
                </template>

                <!-- Otherwise, fall back to the original rich text display -->
                <template if:false={formattedResult}>
                    <div class="ai-result-raw">
                        <lightning-icon icon-name="utility:bot" size="small"></lightning-icon>
                        <lightning-formatted-rich-text value={aiResult}></lightning-formatted-rich-text>
                    </div>
                </template>
            </div>

            <!-- Actions section with new Create Records button -->
            <div class="ai-actions-group">
                <lightning-button-group>
                    <lightning-button variant="neutral" label="Copy" icon-name="utility:copy" onclick={handleCopyToClipboard}></lightning-button>
                    <lightning-button 
                        variant="success" 
                        label="Create Energy Records" 
                        icon-name="utility:add" 
                        onclick={handleCreateRecords}
                        disabled={disableCreateRecordsButton}>
                    </lightning-button>
                </lightning-button-group>
                
                <!-- Loading indicator for record creation -->
                <template if:true={isCreatingRecords}>
                    <div class="ai-loading slds-m-top_small">
                        <div class="ai-loader-small"></div>
                        <span class="ai-analyzing">Creating energy use records...</span>
                    </div>
                </template>
                
                <!-- Success message showing created record count -->
                <template if:true={createdRecordIds.length}>
                    <div class="ai-success slds-m-top_small">
                        <lightning-icon icon-name="utility:success" size="x-small"></lightning-icon>
                        <span>Successfully created {createdRecordIds.length} Energy Use record{createdRecordIds.length}{pluralSuffix}!</span>
                    </div>
                </template>
                
                <template if:true={showActionToast}>
                    <div class="ai-action-toast">{actionToastMessage}</div>
                </template>
            </div>
        </template>
    </div>
</template>
